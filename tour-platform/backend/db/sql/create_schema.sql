DECLARE
    table_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(table_exists, -942);

    TYPE table_list_t IS TABLE OF VARCHAR2(30);
    table_names table_list_t := table_list_t('ITINERARY', 'PAYMENTS', 'BOOKINGS', 'TOUR_PACKAGES', 'ADMINS', 'USERS');

BEGIN
    EXECUTE IMMEDIATE 'ALTER SESSION SET CONSTRAINTS = DEFERRED';

    FOR i IN 1..table_names.COUNT LOOP
        BEGIN
            EXECUTE IMMEDIATE 'DROP TABLE ' || table_names(i) || ' CASCADE CONSTRAINTS';
            DBMS_OUTPUT.PUT_LINE('Dropped table ' || table_names(i));
        EXCEPTION
            WHEN table_exists THEN
                DBMS_OUTPUT.PUT_LINE('Table ' || table_names(i) || ' does not exist, skipping drop.');
        END;
    END LOOP;
    
    EXECUTE IMMEDIATE 'ALTER SESSION SET CONSTRAINTS = IMMEDIATE';

    EXECUTE IMMEDIATE '
    CREATE TABLE USERS (
        USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        EMAIL VARCHAR2(100) NOT NULL UNIQUE,
        PHONE VARCHAR2(20),
        PASSWORD VARCHAR2(255) NOT NULL,
        ROLE VARCHAR2(20) DEFAULT ''user'' NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )';
    DBMS_OUTPUT.PUT_LINE('Table USERS created.');

    EXECUTE IMMEDIATE '
    CREATE TABLE ADMINS (
        ADMIN_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        EMAIL VARCHAR2(100) NOT NULL UNIQUE,
        PHONE VARCHAR2(20),
        PASSWORD VARCHAR2(255) NOT NULL,
        ROLE VARCHAR2(20) DEFAULT ''admin'' NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )';
    DBMS_OUTPUT.PUT_LINE('Table ADMINS created.');

    EXECUTE IMMEDIATE '
    CREATE TABLE TOUR_PACKAGES (
        PACKAGE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        TITLE VARCHAR2(255) NOT NULL,
        DESCRIPTION CLOB,
        PRICE NUMBER(10, 2) NOT NULL,
        START_TIME DATE NOT NULL,
        NUMBER_OF_PEOPLE NUMBER,
        BUS_DETAILS VARCHAR2(255),
        CREATED_BY NUMBER,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )';
    DBMS_OUTPUT.PUT_LINE('Table TOUR_PACKAGES created.');
    
    EXECUTE IMMEDIATE '
    CREATE TABLE BOOKINGS (
        BOOKING_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        USER_ID NUMBER NOT NULL,
        PACKAGE_ID NUMBER NOT NULL,
        TOUR_DATE DATE NOT NULL, -- Added column: The date the tour is scheduled to happen
        BOOKING_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        STATUS VARCHAR2(50) DEFAULT ''Pending'' NOT NULL,
        STARTING_POINT VARCHAR2(255),
        FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE CASCADE,
        FOREIGN KEY (PACKAGE_ID) REFERENCES TOUR_PACKAGES(PACKAGE_ID) ON DELETE CASCADE
    )';
    DBMS_OUTPUT.PUT_LINE('Table BOOKINGS created.');

    EXECUTE IMMEDIATE '
    CREATE TABLE PAYMENTS (
        PAYMENT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        BOOKING_ID NUMBER NOT NULL,
        AMOUNT NUMBER(10, 2) NOT NULL,
        PAYMENT_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (BOOKING_ID) REFERENCES BOOKINGS(BOOKING_ID) ON DELETE CASCADE
    )';
    DBMS_OUTPUT.PUT_LINE('Table PAYMENTS created.');

    EXECUTE IMMEDIATE '
    CREATE TABLE ITINERARY (
        ITEM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        PACKAGE_ID NUMBER NOT NULL,
        DAY NUMBER NOT NULL,
        ACTIVITY VARCHAR2(1000),
        FOREIGN KEY (PACKAGE_ID) REFERENCES TOUR_PACKAGES(PACKAGE_ID) ON DELETE CASCADE
    )';
    DBMS_OUTPUT.PUT_LINE('Table ITINERARY created.');

    EXECUTE IMMEDIATE 'CREATE INDEX idx_bookings_user ON BOOKINGS(USER_ID)';
    EXECUTE IMMEDIATE 'CREATE INDEX idx_bookings_package ON BOOKINGS(PACKAGE_ID)';
    EXECUTE IMMEDIATE 'CREATE INDEX idx_itinerary_package ON ITINERARY(PACKAGE_ID)';
    DBMS_OUTPUT.PUT_LINE('Indexes created.');
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('An unexpected error occurred: ' || SQLERRM);
END;
/
